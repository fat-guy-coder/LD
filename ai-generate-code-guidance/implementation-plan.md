# 实现方案（更新：以增强 Vue/React 单文件体验为主线）

## 一、目标与定位（新的总体策略）

### 1.1 总体目标

LD 的主线目标是：**补足 Vue 单文件（.vue）与 React 单文件（.tsx）的缺点**，并在编译期生成：
- **极快**、**极小体积**、**极好性能**、**极少内存占用** 的最终产物
- 默认输出为 **单个 JS 文件**（包含组件自身状态与函数，生成 DOM 节点，可视为组件）
- 若存在 `style scoped`，则额外输出 **单个 CSS 文件**

> 重点：让开发者尽可能保持原有 Vue/React 语法与工具链心智，不创造新生态。

### 1.2 关键补足点（面向开发者）

- **文件内导出能力**：支持在 `.vue` / `.tsx`（或其编译入口）中导出 TS 类型、变量、函数（解决 Vue SFC 的常见痛点）
- **一致的编译器优化**：无论输入是 Vue 还是 React，最终都走 AOT 编译生成最优 JS/CSS


---

## 二、技术路线（推荐形态）

### 2.1 编译入口与生态集成

优先通过 **Vite 插件 / 编译器插件** 将能力注入到现有生态：
- Vue：`.vue`（基于 `@vue/compiler-sfc`）
- React：`.tsx`（基于 TypeScript / SWC / Babel 解析体系）

### 2.2 编译产物

- **JS**：单文件组件实现（DOM 构建 + 事件绑定 + 状态更新）
- **CSS**：当存在 `scoped` 或需要抽离样式时输出
- **d.ts（可选）**：导出的类型与 API（用于类型消费）

### 2.3 优化策略（AOT）

- 静态提升
- 常量折叠
- 死代码消除
- 事件绑定直接化
- 响应式依赖追踪编译期优化

---

## 三、模块拆解（建议）

### 模块 1：Vue 单文件增强（P0）

**目标**：让 `.vue` 具备更强的导出能力与 AOT 最终产物优化。

- 解析：`@vue/compiler-sfc`
- 能力：
  - 提取并保留导出（`export const` / `export function` / `export type` / `export interface`）
  - 输出最终 JS 时保留导出的 runtime 值
  - 输出 `.d.ts` 时保留导出的类型

### 模块 2：React 单文件增强（P0）

**目标**：让 `.tsx` 进入同一套 AOT 优化链路（最终产物最优），并支持导出类型/值的配套生成。

- 解析：TypeScript AST 或 SWC/Babel AST
- 能力：
  - 组件/JSX 转换为 DOM 构建
  - hooks/状态编译期优化（按你们的 signal/编译模型）
  - `.d.ts` 补全（如需要）

### 模块 3：统一 IR 与 codegen（P0）

**目标**：无论输入 Vue/React，统一转换到 LD IR，再 codegen 到最优 JS/CSS。

- 输入：Vue AST / TSX AST
- 输出：LD IR
- codegen：原生 JS DOM 操作

---

## 四、阶段计划（更新版）

### Phase 1（P0）：导出能力 + 最小可运行编译链路

1. Vue：在编译 `.vue` 时保留并输出导出值与类型
2. React：在编译 `.tsx` 时保留并输出导出值与类型（或至少不破坏既有导出）
3. 产物：单 JS（+ 可选 CSS）

### Phase 2（P0）：性能与体积优化

1. 静态提升/常量折叠/死代码消除
2. 针对 benchmarks 的热点路径优化
3. 产物对标：比等价 Vue/React 应用更小、更快

### Phase 3（P1）：DX 完善

1. IDE 支持（高亮、跳转、诊断）优先针对 `.vue/.tsx` 的增强点
2. 迁移/提示工具

### Phase 4（deferred_optional）：Rust/WASM（后置可选优化项）

- 仅当核心功能、稳定性、性能与体积目标达成后再评估引入
- 不作为主线交付目标

---

## 五、验收标准

- 开发者能继续使用熟悉的 `.vue` / `.tsx` 开发方式
- 增强点（导出能力、编译产物）是显著收益且可验证
- 产物满足：更小、更快、更低内存（相对等价 Vue/React 实现）
- 工具链稳定，不引入编辑器卡死/崩溃等问题

{
  "_meta": {
    "purpose": "AI guidance for LD framework generation. Prioritizes clarity, speed, and strict adherence to goals.",
    "version": "1.7.4-final-restored",
    "lastUpdated": "2026-01-02T22:24:47.118Z"
  },
  "project": {
    "name": "ld",
    "goal": "light!fast!performance!typescript!vue!react! - Beat SolidJS on key metrics.",
    "slogan": "极致性能前端框架",
    "description": "零虚拟DOM、Signal驱动、完全兼容Vue3和React Hooks的前端框架。",
    "performanceTargets": {
      "signalCreate": "<0.01ms",
      "signalGet": "<0.001ms",
      "signalSet": "<0.005ms",
      "libraryBundleSize": "Framework bundle size is NOT a performance metric. The framework can be larger as long as the final compiled output is optimal.",
      "finalAppBundleSize": "The final bundled size of a standard application (e.g., TodoMVC) MUST be smaller than equivalent apps built with competing frameworks. This is the PRIMARY and ONLY measure of size performance. Target: 50%+ smaller than React/Vue equivalents.",
      "componentMount": "<0.1ms",
      "componentUpdate": "<0.05ms",
      "benchmarkGoal": "Metrics must aim to surpass competing frameworks in benchmarks/frameworks-data.json.",
      "compiledOutput": {
        "performance": "Final compiled JavaScript execution speed must exceed SolidJS/Svelte benchmarks",
        "size": "Final application bundle must be 50%+ smaller than React/Vue equivalents",
        "runtime": "ZERO runtime dependency in final output - pure native JavaScript only",
        "memory": "Minimal memory footprint in final application"
      }
    }
  },
  "currentState": {
    "module": "compiler-sfc",
    "file": "src/index.ts",
    "status": "active",
    "notes": "当前主线聚焦于 Vue SFC（.vue）与 TSX（.tsx）的编译增强：导出能力、AOT 最终产物优化，并串联 compiler-core 生成最小、零运行时的原生 JS/CSS 输出。"
  },
  "aiDirectives": {
    "corePrinciples": [
      "MUST_PROPAGATE_CHANGES_TO_ALL_DEPENDENCIES",
      "MUST_READ_THIS_FILE_FIRST",
      "MUST_READ_PACKAGE_JSON_FIRST",
      "MUST_READ_REFERENCE_DOCS",
      "MUST_TREAT_MODULE_TS_AS_SINGLE_SOURCE_OF_TRUTH",
      "MUST_LINT_AFTER_EDIT",
      "MUST_SUGGEST_GUIDANCE_IMPROVEMENTS",
      "MUST_FOLLOW_WORKFLOW_SEQUENCE",
      "MUST_ANALYZE_EXISTING_CODE_BEFORE_GENERATION",
      "MUST_VALIDATE_EACH_STEP_WITH_TESTS",
      "MUST_ANALYZE_FULL_TEST_FAILURE_LOGS_VIA_AI_RUNNER",
      "MUST_UPDATE_`currentState`_AFTER_EACH_ACTION",
      "MUST_USE_CHINESE_FOR_ALL_COMMENTS_JSDOC_AND_DOCS",
      "MUST_PROPAGATE_CHANGES_TO_ALL_DEPENDENCIES",
      "MUST_VERIFY_EXTERNAL_TOOL_DEPENDENCIES",
      "MUST_OPTIMIZE_FOR_FINAL_OUTPUT_NOT_FRAMEWORK_SIZE"
    ],
    "referenceDocuments": {
      "description": "以下MD文档包含重要的设计决策、实现方案和路线图。",
      "required": [
        "ai-generate-code-guidance/implementation-plan.md",
        "ai-generate-code-guidance/roadmap.md"
      ],
      "whenToRead": {
        "beforeCompilerWork": "在开发编译器相关功能前，必须阅读implementation-plan.md",
        "planningPhase": "在规划开发任务时，必须阅读roadmap.md了解整体路线图"
      }
    },
    "productStrategy": {
      "positioning": "目标是让 Vue/React 开发体验更好，而不是创造全新的生态或强制开发者学习新语法。",
      "principles": [
        "优先复用 Vue/React 既有语法与工具链（Volar、TS Server、Prettier 等）",
        "新文件格式/新语法仅在显著提升产物质量与 DX 且无法通过插件方式实现时才引入",
        "以渐进式增强为主：先保证高亮/类型/诊断/格式化等 IDE 体验稳定，再逐步开放更多能力"
      ],
      "rustWasm": {
        "priority": "deferred_optional",
        "policy": "Rust/C++/WASM 属于可选优化项。仅在核心功能（编译链路、导出能力、稳定 IDE 体验、性能与体积目标）全部完成后再评估与实现。",
        "rationale": "WASM 集成会显著增加工具链复杂度与维护成本，过早引入会分散主线目标。"
      }
    },
    "prohibitions": [
      "NO_SKIP_VALIDATION_OR_TESTS",
      "NO_MODIFY_THIS_GUIDANCE_FILE",
      "NO_CODE_THAT_VIOLATES_`architecture`_PRINCIPLES",
      "NO_GENERATE_CODE_WITHOUT_ANALYZING_EXPORTS",
      "NO_PROCEED_IF_TESTS_FAIL",
      "NO_FILE_SCOPED_STATE_VARIABLES"
    ],
    "continuousImprovement": "If optimization opportunities are discovered that should be standardized, you MUST suggest updating this guidance file.",
    "codeGenerationRules": {
      "NO_UNUSED_VARIABLES": "All declared variables and imports MUST be used or removed.",
      "OPTIMAL_LOOPS": "Use reverse for-loops for unordered iteration in hot paths; cache array length for ordered iteration.",
      "OPTIMAL_ALGORITHMS": "Core algorithms MUST have the lowest possible time and space complexity."
    },
    "stateManagementProtocol": {
      "sourceOfTruth": "All state MUST be managed via `packages/reactivity/src/store.ts`.",
      "global": "All cross-module shared state MUST be in the `globalState` object.",
      "instance": "All component-specific state MUST use `createInstanceStore` for isolation.",
      "noFileScopeVars": "STRICTLY FORBIDDEN: Do NOT use file-scoped variables for state."
    },
    "startupChecklist": {
      "step1": "Read this guidance file (ai-guidance.json).",
      "step2": "Read package.json to understand available scripts and dependencies.",
      "step3": "Read reference documents in aiDirectives.referenceDocuments.required based on current task.",
      "step4": "Understand AOT compilation philosophy: framework size doesn't matter, final output quality is everything.",
      "step5": "Optionally, read context files from workflow.details as needed."
    }
  },
  "workflow": {
    "sequence": [
      "1_ANALYZE_CODEBASE",
      "2_DESIGN_CODE_STRUCTURE",
      "3_GENERATE_CODE",
      "4_UPDATE_MODULE_EXPORTS",
      "5_GENERATE_OR_UPDATE_TESTS",
      "6_EXECUTE_TESTS",
      "7_PERFORMANCE_TUNING",
      "8_BUILD_MODULE",
      "9_ANALYZE_BUNDLE",
      "10_UPDATE_CURRENT_STATE"
    ],
    "details": {
      "1_ANALYZE_CODEBASE": {
        "description": "Analyze context. Priority 1: Read `packages/module.ts`, the Single Source of Truth for all public APIs.",
        "filesToAnalyze": [
          "packages/module.ts",
          "packages/{currentState.module}/src/index.ts"
        ]
      },
      "3_GENERATE_CODE": {
        "description": "Generate TypeScript code for the target file.",
        "rules": [
          "Adhere strictly to `codeStyle` and `templates`.",
          "Ensure all `qualityGates` are met.",
          "Performance is the highest priority."
        ]
      },
      "4_UPDATE_MODULE_EXPORTS": {
        "description": "Update the module's `index.ts` and then the main `packages/module.ts`.",
        "filesToUpdate": [
          "packages/{currentState.module}/src/index.ts",
          "packages/module.ts"
        ],
        "rules": [
          "`packages/module.ts` MUST fully re-export all public APIs from every module's `index.ts`.",
          "Every export block in `packages/module.ts` MUST have a JSDoc comment indicating its source module (e.g., `// from @ld/reactivity`).",
          "Any changes to a module's exported variables or functions MUST be immediately synchronized with the module's `index.ts` and subsequently with the main `packages/module.ts`, including any necessary updates to JSDoc comments."
        ]
      },
      "5_GENERATE_OR_UPDATE_TESTS": {
        "description": "Create or update the test file for the generated code.",
        "pathTemplate": "packages/{currentState.module}/test/{filename}.test.ts",
        "requiredCoverage": [
          "normalCase",
          "boundaryCase",
          "errorCase",
          "regressionCase_afterFix"
        ]
      },
      "6_EXECUTE_TESTS": {
        "description": "Run tests for the modified file and ensure 100% pass rate. Fix any failures before proceeding.",
        "command": "pnpm test:ai -- packages/{currentState.module}/test/{filename}.test.ts"
      },
      "7_PERFORMANCE_TUNING": {
        "description": "Conduct performance and memory analysis. Skippable for non-runtime modules (e.g., `cli`).",
        "steps": [
          "1_CREATE_OR_UPDATE_BENCHMARKS",
          "2_RUN_BENCHMARKS_AND_ANALYZE",
          "3_CREATE_OR_UPDATE_MEMORY_TESTS",
          "4_RUN_MEMORY_TESTS_AND_ANALYZE",
          "5_IMPLEMENT_OPTIMIZATIONS",
          "6_VALIDATE_GAINS"
        ],
        "commands": {
          "benchmark": "pnpm bench",
          "memory": "pnpm tsx scripts/memory.mts"
        },
        "qualityGate": "Performance and memory usage must meet targets and be competitive with data in `statistics/frameworks-data.json`.",
        "rules": [
          "If API changes are made during optimization, corresponding unit tests MUST be updated before re-running `6_EXECUTE_TESTS` to ensure correctness.",
          "Any refactoring of a core API (e.g., in @ld/reactivity) for performance or other reasons MUST trigger a review and update of ALL dependent files, including unit tests, benchmark tests, and memory tests across ALL modules."
        ]
      },
      "8_BUILD_MODULE": {
        "description": "Package the current module for distribution.",
        "tool": "Rollup/tsup",
        "rules": [
          "Do not include test, benchmark, or memory files in the final bundle."
        ]
      },
      "9_ANALYZE_BUNDLE": {
        "description": "Analyze the final library bundle size and dependencies. Optimize if not as expected.",
        "command": "pnpm analyze",
        "qualityGate": "Library bundle size must align with performance targets. No unexpected dependencies."
      },
      "10_UPDATE_CURRENT_STATE": {
        "description": "Update the `currentState` object in this file to prepare for the next module."
      }
    }
  },
  "architecture": {
    "nonNegotiable": [
      "zeroVirtualDOM",
      "signalBasedReactivity",
      "fullVue3AndReactCompatibility",
      "absoluteTypeSafety",
      "extremePerformance",
      "minimalFinalAppBundleSize",
      "minimalAotMemoryFootprint",
      "typeFileIsolationForCircularDependencies"
    ],
    "lazyLoading": {
      "components": "All components and routes MUST support code-splitting via dynamic import().",
      "styles": "Compiler MUST output separate CSS files. Runtime MUST dynamically inject styles on first component mount.",
      "fetchStrategy": "Runtime MUST allow custom fetch logic, defaulting to native browser import() or fetch()."
    },
    "compilation": {
      "strategy": "AOT (Ahead-of-Time) only. Development-time speed is secondary to final output quality.",
      "goal": "Generate the most optimal, performant, and smallest possible native JavaScript code for direct DOM manipulation. The final bundle's performance, size, and memory usage are the highest priorities.",
      "aotPhilosophy": {
        "principle": "LD框架采用AOT编译模式，最终编译产物才是衡量框架特性的标准。框架本身的包大小不重要，重要的是编译后的代码具有高性能、高执行速度和小体积。",
        "frameworkSize": "框架包可以大一些，只要最终编译产物优秀即可。框架包大小不是性能指标。",
        "finalOutputMetrics": {
          "performance": "最终编译产物的执行速度必须超越竞争对手（SolidJS、Svelte等）",
          "bundleSize": "最终应用的Bundle Size必须比使用React/Vue构建的同等应用小50%以上",
          "memoryUsage": "最终应用的内存占用必须最小化",
          "runtime": "最终编译产物必须零运行时依赖，纯原生JavaScript"
        },
        "optimizationTarget": "所有优化工作都应该针对最终编译产物，而不是框架本身的代码。编译器的复杂度可以接受，只要最终输出优秀。"
      },
      "sfc": {
        "parser": "@vue/compiler-sfc",
        "transformer": "@ld/compiler-core (custom)",
        "generator": "@ld/compiler-core (custom)",
        "output": "Direct DOM manipulations, no VDOM."
      },
      "jsx": {
        "parser": "@babel/parser",
        "transformer": "@ld/babel-plugin-ld",
        "output": "Calls to `@ld/runtime-jsx` functions, no VDOM."
      }
    }
  },
  "modules": {
    "generationOrder": [
      "reactivity",
      "runtime-core",
      "runtime-dom",
      "runtime-jsx",
      "react",
      "vue",
      "compiler-core",
      "compiler-sfc",
      "router",
      "ld",
      "vite-plugin",
      "cli",
      "devtools",
      "babel-plugin-ld",
      "canvas-renderer",
      "wasm-bridge"
    ],
    "competitiveFeatures": {
      "zeroRuntime": {
        "priority": "P0",
        "description": "完全零运行时，编译后纯原生JavaScript",
        "status": "in-progress",
        "modules": [
          "compiler-core",
          "compiler-sfc"
        ]
      },
      "canvasOptimization": {
        "priority": "P0",
        "description": "Canvas/SVG高性能渲染，WebGL/WebGPU加速",
        "status": "planned",
        "modules": [
          "canvas-renderer"
        ]
      },
      "islandsArchitecture": {
        "priority": "P1",
        "description": "Islands架构 + SSR支持",
        "status": "planned",
        "modules": [
          "compiler-core",
          "runtime-core"
        ]
      },
      "exportCapability": {
        "priority": "P0",
        "description": "支持从 .vue / .tsx 编译入口导出变量与 TypeScript 类型",
        "status": "in-progress",
        "modules": [
          "compiler-sfc"
        ]
      }
    }
  },
  "codeStyle": {
    "naming": {
      "functions": "camelCase",
      "types": "PascalCase",
      "constants": "UPPER_SNAKE_CASE"
    },
    "imports": {
      "internal": "from './index'",
      "external": "from '@ld/moduleName'",
      "typeOnly": "import type { ... }"
    },
    "exports": {
      "rule": "In a module's `index.ts`, group exports by source file. In `packages/module.ts`, create a dedicated block for each module and re-export all its public APIs with a clear comment indicating the source (e.g., `// from @ld/reactivity`)."
    }
  },
  "templates": {
    "jsdoc": {
      "function": {
        "required": [
          "@description",
          "@param",
          "@returns",
          "@example",
          "@performance",
          "@since"
        ],
        "example": "/**\n * @description ...\n * @param ...\n * @returns ...\n * @example ...\n * @performance ...\n * @since v0.1.0\n */"
      }
    }
  },
  "testing": {
    "strategy": "Intelligent Selective Testing",
    "description": "Test runners (`test.mts`, `test-ai.mts`) dynamically select packages to test based on `generate-code-guidance.json` status.",
    "logic": {
      "sourceOfTruth": "ai-generate-code-guidance/generate-code-guidance.json",
      "helperScript": "scripts/utils/get-active-packages.mts",
      "criteria": "Only packages with status 'completed' or 'active' are tested.",
      "fallback": "If guidance file is unreadable, all packages are tested."
    },
    "commands": {
      "ai_runner": "pnpm test:ai",
      "standard_runner": "pnpm test"
    }
  },
  "tooling": {
    "linter": "ESLint",
    "formatter": "Prettier",
    "bundler": "Rollup/tsup",
    "benchmark": "tinybench"
  },
  "qualityGates": {
    "performance": "All code must be JIT-friendly with minimal GC overhead.",
    "dependencies": "Dependency graph must be a DAG (no circular dependencies).",
    "types": "`any` type is strictly forbidden.",
    "typescriptValidation": "Source code in `packages/**/src` MUST have zero TS errors. For other files (scripts, tests, benchmarks), ensuring no errors in the IDE's TS server is sufficient; ESLint is not mandatory.",
    "lintAfterEdit": "After any modification to a `.ts` or `.mts` file, you MUST run the linter to ensure zero errors before proceeding.",
    "testing": "Every new feature or fix must be accompanied by a passing test."
  }
}
